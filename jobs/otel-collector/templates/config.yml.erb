<%=
otlp_grpc_endpoint = "127.0.0.1:#{p('ingress.grpc.port')}"

config = {
  "receivers"=> {
    "otlp"=>{
      "protocols"=>{
        "grpc"=>{
          "endpoint"=>otlp_grpc_endpoint,
          "tls"=>{
            "client_ca_file"=>"/var/vcap/jobs/otel-collector/config/certs/otel-collector-ca.crt",
             "cert_file"=>"/var/vcap/jobs/otel-collector/config/certs/otel-collector.crt",
             "key_file"=>"/var/vcap/jobs/otel-collector/config/certs/otel-collector.key",
             "min_version"=>"1.3"
          }
        }
      }
    }
  },
  "exporters"=>p('metric_exporters'),
  "service"=>{
    "telemetry"=>{"metrics"=>{"level"=>"none"}},
    "pipelines"=>{"metrics"=>{"receivers"=>["otlp"], "exporters"=>p('metric_exporters').keys}}
  }
}

YAML::dump(config)
%>
